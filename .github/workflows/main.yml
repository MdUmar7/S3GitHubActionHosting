name: Deploy to EC2 Web Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/github_runner
        chmod 600 ~/.ssh/github_runner
        ssh-keyscan -H ${{ secrets.WEB_SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Deploy to web server
      run: |
        # Copy files to web server
        rsync -avz -e "ssh -i ~/.ssh/github_runner -o StrictHostKeyChecking=no" \
          --delete \
          ./ ubuntu@${{ secrets.WEB_SERVER_IP }}:/var/www/html/

        # Restart Apache (if needed)
        ssh -i ~/.ssh/github_runner -o StrictHostKeyChecking=no \
          ubuntu@${{ secrets.WEB_SERVER_IP }} "sudo systemctl restart apache2"

    - name: Verify deployment
      run: |
        curl -s http://${{ secrets.WEB_SERVER_IP }} | head -n 10
###########################################
#name: Deploy Static Website to S3

#on:
 # push:
  #  branches:
   #   - main

#jobs:
 # deploy:
  #  runs-on: ubuntu-latest

#    steps:
 #     - name: Checkout Code
  #      uses: actions/checkout@v4


   #   - name: Copy files to EC2
    #    uses: appleboy/scp-action@v0.1.7
     #   with:
      #    host: ${{ secrets.EC2_HOST }}
       #   username: ubuntu
        #  key: ${{ secrets.EC2_KEY }}
         # port: 22
          #source: "."
          #target: "/var/www/html"

      #- name: Restart Nginx
       # uses: appleboy/ssh-action@v1.0.3
        #with:
         # host: ${{ secrets.EC2_HOST }}
          #username: ubuntu
          #key: ${{ secrets.EC2_KEY }}
          #script: |
           # sudo systemctl reload nginx
        
      #- name: Configure AWS Credentials
       # uses: aws-actions/configure-aws-credentials@v4
        #with:
         # aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          #aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          #aws-region: ${{ secrets.AWS_REGION }}

      #- name: Deploy files to S3
       # run: |
        #  aws s3 sync . s3://${{ secrets.S3_BUCKET_NAME }} \
         #   --exclude ".git/*" \
          #  --exclude ".github/*"
